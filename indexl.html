<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ë¬¸ì œ ìƒì„±ê¸° (v.1.3)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007bff; --secondary-color: #6c757d; --danger-color: #dc3545;
      --background-color: #f8f9fa; --section-bg-color: #ffffff; --text-color: #212529;
      --light-text-color: #6c757d; --border-color: #dee2e6;
    }
    body { font-family: 'Noto Sans KR', sans-serif; max-width: 800px; margin: 20px auto; padding: 0 15px; background-color: var(--background-color); color: var(--text-color); }
    h1 { text-align: center; color: var(--primary-color); font-weight: 700; margin-bottom: 30px; }
    .section-box { margin-bottom: 25px; border: 1px solid var(--border-color); padding: 25px; border-radius: 12px; background-color: var(--section-bg-color); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
    label.section-title { font-weight: 700; font-size: 1.2em; color: var(--text-color); display: flex; align-items: center; gap: 8px; margin-bottom: 15px; }
    .api-wrapper, .input-group, .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .button-group, .button-group-right { display: flex; gap: 10px; }
    .button-group { margin-top: 20px; }
    input[type="password"], input[type="file"], input[type="number"] { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
    input[type="number"] { max-width: 70px; text-align: center; flex-grow: 0; }
    input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; }
    .checkbox-group label { font-size: 1em; margin-bottom: 0; font-weight: 400; }
    button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: 500; font-size: 1em; transition: all 0.2s ease-in-out; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
    #save-btn, #generate-btn { background-color: var(--primary-color); color: white; }
    #edit-btn, #view-sheet-btn { background-color: var(--secondary-color); color: white; }
    #delete-btn { background-color: var(--danger-color); color: white; }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #status { margin-top: 15px; font-style: italic; color: var(--light-text-color); min-height: 1.2em; }
    .error-message { color: var(--danger-color); font-size: 0.9em; margin-top: 8px; min-height: 1em; }
    #result-container { margin-top: 20px; }
    #result-table { width: 100%; border-collapse: collapse; }
    #result-table th, #result-table td { border: 1px solid var(--border-color); padding: 14px; text-align: left; vertical-align: top; }
    #result-table th { background-color: #495057; color: white; }
    #result-table tr:nth-child(even) { background-color: #f8f9fa; }
    #result-table td:first-child { width: 75%; line-height: 1.6; }
    footer { text-align: center; margin-top: 50px; padding-top: 30px; font-size: 0.85em; color: var(--light-text-color); border-top: 1px solid var(--border-color); }
    footer p { margin: 4px 0; }
  </style>
</head>
<body>
  <h1>AI ë¬¸ì œ ìƒì„±ê¸° âœ¨</h1>

  <div class="section-box">
    <label class="section-title">ğŸ”‘ API í‚¤ ê´€ë¦¬(Gemini api ì‚¬ìš©)</label>
    <div id="api-input-wrapper" class="api-wrapper">
      <input type="password" id="llm-api-key" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      <button id="save-btn">ì €ì¥</button>
    </div>
    <div id="api-display-wrapper" class="api-wrapper" style="display:none;">
      <span><strong>API í‚¤ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></span>
      <div class="button-group-right">
        <button id="edit-btn">ìˆ˜ì •</button>
        <button id="delete-btn">ì‚­ì œ</button>
      </div>
    </div>
    <div id="api-error-container" class="error-message"></div>
  </div>

  <div class="section-box">
    <label class="section-title">ğŸ“„ ë¬¸ì œ ìƒì„± ì„¤ì •(pdf íŒŒì¼ë¡œ ë„£ì–´ì£¼ì„¸ìš”)</label>
    <div class="input-group">
      <input type="file" id="pdf-upload" accept=".pdf" style="flex-grow: 2;">
      <label for="num-problems" style="font-size:1em; font-weight:normal; margin-bottom:0;">ê°œìˆ˜:</label>
      <input type="number" id="num-problems" value="10" min="1" max="20" title="ìƒì„±í•  ë¬¸ì œ ê°œìˆ˜">
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="save-to-sheet" checked>
      <label for="save-to-sheet">êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥í•˜ê¸°</label>
    </div>
    <div class="button-group">
      <button id="generate-btn">ë¬¸ì œ ìƒì„±í•˜ê¸°</button>
      <button id="view-sheet-btn" style="display: none;">ì‹œíŠ¸ í™•ì¸í•˜ê¸°</button>
    </div>
    <div id="status"></div>
  </div>
  
  <div id="result-container"></div>

  <footer>
    <p id="copyright-notice"> </p>
    <p>ì„ ìƒë‹˜ë“¤ì˜ ì‹œê°„ì„ ì•„ê»´ë“œë¦¬ëŠ” AI ë¬¸ì œ ìƒì„±ê¸°</p>
  </footer>

  <script>
    const inputWrapper = document.getElementById('api-input-wrapper');
    const displayWrapper = document.getElementById('api-display-wrapper');
    const apiKeyInput = document.getElementById('llm-api-key');
    const saveBtn = document.getElementById('save-btn');
    const editBtn = document.getElementById('edit-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const apiErrorContainer = document.getElementById('api-error-container');
    const generateBtn = document.getElementById('generate-btn');
    const viewSheetBtn = document.getElementById('view-sheet-btn');

    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
    document.addEventListener('DOMContentLoaded', () => {
      google.script.run.withSuccessHandler(setupApiKeyUI).withFailureHandler(handleApiError).getApiKey();
      const copyrightNotice = document.getElementById('copyright-notice');
      const currentYear = new Date().getFullYear();
      copyrightNotice.textContent = `Copyright Â© ${currentYear} HR Yoon. All Rights Reserved.`;
    });

    // --- API í‚¤ ê´€ë¦¬ ë¡œì§ ---
    function setupApiKeyUI(savedKey) {
      if (savedKey) { inputWrapper.style.display = 'none'; displayWrapper.style.display = 'flex'; } 
      else { inputWrapper.style.display = 'flex'; displayWrapper.style.display = 'none'; }
    }
    saveBtn.addEventListener('click', () => {
      apiErrorContainer.textContent = '';
      const newKey = apiKeyInput.value.trim();
      if (!newKey) { apiErrorContainer.textContent = 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'; return; }
      saveBtn.disabled = true; saveBtn.textContent = 'ì €ì¥ ì¤‘...';
      google.script.run.withSuccessHandler(handleSaveSuccess).withFailureHandler(handleApiError).saveApiKey(newKey);
    });
    function handleSaveSuccess(response) {
      saveBtn.disabled = false; saveBtn.textContent = 'ì €ì¥';
      if (response.success) {
        inputWrapper.style.display = 'none';
        displayWrapper.style.display = 'flex';
      } else { apiErrorContainer.textContent = response.message; }
    }
    editBtn.addEventListener('click', () => {
      apiErrorContainer.textContent = '';
      inputWrapper.style.display = 'flex'; displayWrapper.style.display = 'none';
      apiKeyInput.value = ''; apiKeyInput.placeholder = 'ìƒˆë¡œìš´ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”'; apiKeyInput.focus();
    });
    deleteBtn.addEventListener('click', () => {
      if (confirm("ì €ì¥ëœ API í‚¤ë¥¼ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        apiErrorContainer.textContent = 'ì‚­ì œ ì¤‘...';
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              apiErrorContainer.textContent = '';
              setupApiKeyUI(null); // UIë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
            } else {
              apiErrorContainer.textContent = 'ì˜¤ë¥˜: ' + response.message;
            }
          })
          .withFailureHandler(handleApiError)
          .deleteApiKey();
      }
    });
    function handleApiError(error) {
      saveBtn.disabled = false; saveBtn.textContent = 'ì €ì¥';
      apiErrorContainer.textContent = 'ì˜¤ë¥˜: ' + error.message;
    }

    // --- ë¬¸ì œ ìƒì„± ë° ì‹œíŠ¸ í™•ì¸ ë¡œì§ ---
    generateBtn.addEventListener('click', () => {
      const fileInput = document.getElementById('pdf-upload');
      const numProblemsInput = document.getElementById('num-problems');
      const saveToSheetCheckbox = document.getElementById('save-to-sheet');
      if (fileInput.files.length === 0) { alert("PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
      const file = fileInput.files[0];
      const reader = new FileReader();
      const statusDiv = document.getElementById('status');
      const resultContainer = document.getElementById('result-container');
      statusDiv.textContent = 'íŒŒì¼ì„ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...';
      resultContainer.innerHTML = '';
      generateBtn.disabled = true; generateBtn.textContent = 'ìƒì„± ì¤‘...';
      if (!saveToSheetCheckbox.checked) { viewSheetBtn.style.display = 'none'; }
      reader.onload = function(event) {
        const fileData = event.target.result.split(',')[1];
        const fileObject = {
          fileName: file.name, mimeType: file.type, fileBytes: fileData,
          numProblems: numProblemsInput.value,
          saveToSheet: saveToSheetCheckbox.checked
        };
        google.script.run.withSuccessHandler(handleGenerationSuccess).withFailureHandler(handleGenerationError).processPdfAndGenerateProblems(fileObject);
      };
      reader.readAsDataURL(file);
    });
    viewSheetBtn.addEventListener('click', () => {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = 'ì‹œíŠ¸ ì£¼ì†Œë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...';
      google.script.run
        .withSuccessHandler((url) => {
          statusDiv.textContent = '';
          if (url.startsWith('http')) { window.open(url, '_blank'); } 
          else { alert(url); }
        })
        .withFailureHandler((error) => { statusDiv.textContent = "ì˜¤ë¥˜ ë°œìƒ: " + error.message; })
        .getSheetUrl();
    });
    function handleGenerationSuccess(responseObject) {
      const resultContainer = document.getElementById('result-container');
      const statusDiv = document.getElementById('status');
      const viewSheetBtn = document.getElementById('view-sheet-btn');
      const htmlTable = responseObject.htmlTable;
      resultContainer.innerHTML = `
        <h2>ìƒì„±ëœ ë¬¸ì œ</h2>
        <table id="result-table">
          <thead><tr><th>ë¬¸ì œ</th><th>ì •ë‹µ</th></tr></thead>
          <tbody>${htmlTable.replace(/<\/?table>/g, '')}</tbody>
        </table>`;
      statusDiv.textContent = "ë¬¸ì œ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
      if (responseObject.didSaveToSheet) { viewSheetBtn.style.display = 'inline-block'; }
      generateBtn.disabled = false; generateBtn.textContent = 'ë¬¸ì œ ìƒì„±í•˜ê¸°';
    }
    function handleGenerationError(error) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = "ì˜¤ë¥˜ ë°œìƒ: " + error.message;
      generateBtn.disabled = false; generateBtn.textContent = 'ë¬¸ì œ ìƒì„±í•˜ê¸°';
    }
  </script>
</body>
</html>