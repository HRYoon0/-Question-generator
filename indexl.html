<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI 문제 생성기 (v.1.3)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007bff; --secondary-color: #6c757d; --danger-color: #dc3545;
      --background-color: #f8f9fa; --section-bg-color: #ffffff; --text-color: #212529;
      --light-text-color: #6c757d; --border-color: #dee2e6;
    }
    body { font-family: 'Noto Sans KR', sans-serif; max-width: 800px; margin: 20px auto; padding: 0 15px; background-color: var(--background-color); color: var(--text-color); }
    h1 { text-align: center; color: var(--primary-color); font-weight: 700; margin-bottom: 30px; }
    .section-box { margin-bottom: 25px; border: 1px solid var(--border-color); padding: 25px; border-radius: 12px; background-color: var(--section-bg-color); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
    label.section-title { font-weight: 700; font-size: 1.2em; color: var(--text-color); display: flex; align-items: center; gap: 8px; margin-bottom: 15px; }
    .api-wrapper, .input-group, .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .button-group, .button-group-right { display: flex; gap: 10px; }
    .button-group { margin-top: 20px; }
    input[type="password"], input[type="file"], input[type="number"] { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
    input[type="number"] { max-width: 70px; text-align: center; flex-grow: 0; }
    input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; }
    .checkbox-group label { font-size: 1em; margin-bottom: 0; font-weight: 400; }
    button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: 500; font-size: 1em; transition: all 0.2s ease-in-out; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
    #save-btn, #generate-btn { background-color: var(--primary-color); color: white; }
    #edit-btn, #view-sheet-btn { background-color: var(--secondary-color); color: white; }
    #delete-btn { background-color: var(--danger-color); color: white; }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #status { margin-top: 15px; font-style: italic; color: var(--light-text-color); min-height: 1.2em; }
    .error-message { color: var(--danger-color); font-size: 0.9em; margin-top: 8px; min-height: 1em; }
    #result-container { margin-top: 20px; }
    #result-table { width: 100%; border-collapse: collapse; }
    #result-table th, #result-table td { border: 1px solid var(--border-color); padding: 14px; text-align: left; vertical-align: top; }
    #result-table th { background-color: #495057; color: white; }
    #result-table tr:nth-child(even) { background-color: #f8f9fa; }
    #result-table td:first-child { width: 75%; line-height: 1.6; }
    footer { text-align: center; margin-top: 50px; padding-top: 30px; font-size: 0.85em; color: var(--light-text-color); border-top: 1px solid var(--border-color); }
    footer p { margin: 4px 0; }
  </style>
</head>
<body>
  <h1>AI 문제 생성기 ✨</h1>

  <div class="section-box">
    <label class="section-title">🔑 API 키 관리(Gemini api 사용)</label>
    <div id="api-input-wrapper" class="api-wrapper">
      <input type="password" id="llm-api-key" placeholder="API 키를 입력하세요">
      <button id="save-btn">저장</button>
    </div>
    <div id="api-display-wrapper" class="api-wrapper" style="display:none;">
      <span><strong>API 키가 안전하게 저장되었습니다.</strong></span>
      <div class="button-group-right">
        <button id="edit-btn">수정</button>
        <button id="delete-btn">삭제</button>
      </div>
    </div>
    <div id="api-error-container" class="error-message"></div>
  </div>

  <div class="section-box">
    <label class="section-title">📄 문제 생성 설정(pdf 파일로 넣어주세요)</label>
    <div class="input-group">
      <input type="file" id="pdf-upload" accept=".pdf" style="flex-grow: 2;">
      <label for="num-problems" style="font-size:1em; font-weight:normal; margin-bottom:0;">개수:</label>
      <input type="number" id="num-problems" value="10" min="1" max="20" title="생성할 문제 개수">
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="save-to-sheet" checked>
      <label for="save-to-sheet">구글 시트에 저장하기</label>
    </div>
    <div class="button-group">
      <button id="generate-btn">문제 생성하기</button>
      <button id="view-sheet-btn" style="display: none;">시트 확인하기</button>
    </div>
    <div id="status"></div>
  </div>
  
  <div id="result-container"></div>

  <footer>
    <p id="copyright-notice"> </p>
    <p>선생님들의 시간을 아껴드리는 AI 문제 생성기</p>
  </footer>

  <script>
    const inputWrapper = document.getElementById('api-input-wrapper');
    const displayWrapper = document.getElementById('api-display-wrapper');
    const apiKeyInput = document.getElementById('llm-api-key');
    const saveBtn = document.getElementById('save-btn');
    const editBtn = document.getElementById('edit-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const apiErrorContainer = document.getElementById('api-error-container');
    const generateBtn = document.getElementById('generate-btn');
    const viewSheetBtn = document.getElementById('view-sheet-btn');

    // --- 페이지 로드 시 실행 ---
    document.addEventListener('DOMContentLoaded', () => {
      google.script.run.withSuccessHandler(setupApiKeyUI).withFailureHandler(handleApiError).getApiKey();
      const copyrightNotice = document.getElementById('copyright-notice');
      const currentYear = new Date().getFullYear();
      copyrightNotice.textContent = `Copyright © ${currentYear} HR Yoon. All Rights Reserved.`;
    });

    // --- API 키 관리 로직 ---
    function setupApiKeyUI(savedKey) {
      if (savedKey) { inputWrapper.style.display = 'none'; displayWrapper.style.display = 'flex'; } 
      else { inputWrapper.style.display = 'flex'; displayWrapper.style.display = 'none'; }
    }
    saveBtn.addEventListener('click', () => {
      apiErrorContainer.textContent = '';
      const newKey = apiKeyInput.value.trim();
      if (!newKey) { apiErrorContainer.textContent = 'API 키를 입력해주세요.'; return; }
      saveBtn.disabled = true; saveBtn.textContent = '저장 중...';
      google.script.run.withSuccessHandler(handleSaveSuccess).withFailureHandler(handleApiError).saveApiKey(newKey);
    });
    function handleSaveSuccess(response) {
      saveBtn.disabled = false; saveBtn.textContent = '저장';
      if (response.success) {
        inputWrapper.style.display = 'none';
        displayWrapper.style.display = 'flex';
      } else { apiErrorContainer.textContent = response.message; }
    }
    editBtn.addEventListener('click', () => {
      apiErrorContainer.textContent = '';
      inputWrapper.style.display = 'flex'; displayWrapper.style.display = 'none';
      apiKeyInput.value = ''; apiKeyInput.placeholder = '새로운 API 키를 입력하세요'; apiKeyInput.focus();
    });
    deleteBtn.addEventListener('click', () => {
      if (confirm("저장된 API 키를 정말로 삭제하시겠습니까?")) {
        apiErrorContainer.textContent = '삭제 중...';
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              apiErrorContainer.textContent = '';
              setupApiKeyUI(null); // UI를 초기 상태로 되돌립니다.
            } else {
              apiErrorContainer.textContent = '오류: ' + response.message;
            }
          })
          .withFailureHandler(handleApiError)
          .deleteApiKey();
      }
    });
    function handleApiError(error) {
      saveBtn.disabled = false; saveBtn.textContent = '저장';
      apiErrorContainer.textContent = '오류: ' + error.message;
    }

    // --- 문제 생성 및 시트 확인 로직 ---
    generateBtn.addEventListener('click', () => {
      const fileInput = document.getElementById('pdf-upload');
      const numProblemsInput = document.getElementById('num-problems');
      const saveToSheetCheckbox = document.getElementById('save-to-sheet');
      if (fileInput.files.length === 0) { alert("PDF 파일을 선택해주세요."); return; }
      const file = fileInput.files[0];
      const reader = new FileReader();
      const statusDiv = document.getElementById('status');
      const resultContainer = document.getElementById('result-container');
      statusDiv.textContent = '파일을 서버로 전송 중...';
      resultContainer.innerHTML = '';
      generateBtn.disabled = true; generateBtn.textContent = '생성 중...';
      if (!saveToSheetCheckbox.checked) { viewSheetBtn.style.display = 'none'; }
      reader.onload = function(event) {
        const fileData = event.target.result.split(',')[1];
        const fileObject = {
          fileName: file.name, mimeType: file.type, fileBytes: fileData,
          numProblems: numProblemsInput.value,
          saveToSheet: saveToSheetCheckbox.checked
        };
        google.script.run.withSuccessHandler(handleGenerationSuccess).withFailureHandler(handleGenerationError).processPdfAndGenerateProblems(fileObject);
      };
      reader.readAsDataURL(file);
    });
    viewSheetBtn.addEventListener('click', () => {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = '시트 주소를 확인 중입니다...';
      google.script.run
        .withSuccessHandler((url) => {
          statusDiv.textContent = '';
          if (url.startsWith('http')) { window.open(url, '_blank'); } 
          else { alert(url); }
        })
        .withFailureHandler((error) => { statusDiv.textContent = "오류 발생: " + error.message; })
        .getSheetUrl();
    });
    function handleGenerationSuccess(responseObject) {
      const resultContainer = document.getElementById('result-container');
      const statusDiv = document.getElementById('status');
      const viewSheetBtn = document.getElementById('view-sheet-btn');
      const htmlTable = responseObject.htmlTable;
      resultContainer.innerHTML = `
        <h2>생성된 문제</h2>
        <table id="result-table">
          <thead><tr><th>문제</th><th>정답</th></tr></thead>
          <tbody>${htmlTable.replace(/<\/?table>/g, '')}</tbody>
        </table>`;
      statusDiv.textContent = "문제 생성이 완료되었습니다.";
      if (responseObject.didSaveToSheet) { viewSheetBtn.style.display = 'inline-block'; }
      generateBtn.disabled = false; generateBtn.textContent = '문제 생성하기';
    }
    function handleGenerationError(error) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = "오류 발생: " + error.message;
      generateBtn.disabled = false; generateBtn.textContent = '문제 생성하기';
    }
  </script>
</body>
</html>